{% extends "base.html" %}

{% block title %}Inactive User Report{% endblock %}

{% block content %}
<div class="report-block">
    <form method="get" action="">
        <input type="hidden" name="report" value="Inactive User Report">
        <label for="start_date">Start Date:</label>
        <input type="date" id="start_date" name="start_date" value="{{ start_date|default:start_date_default|date:'Y-m-d' }}" required>
        <label for="end_date">End Date:</label>
        <input type="date" id="end_date" name="end_date" value="{{ end_date|default:end_date_default|date:'Y-m-d' }}" required>
        <button type="submit">Apply Filters</button>
    </form>
    <h4>Inactive User Report</h4>
    <p>This report is for inactive users date start: {{ start_date }} and end: {{ end_date }}</p>
    <table border="1">
        <thead>
            <tr>
                <th>Username</th>
                <th>Last Activity</th>
                <th>Total Deposits</th>
                <th>Total Withdrawals</th>
                <th>Days Inactive</th>
            </tr>
        </thead>
        <tbody>
            {% for user in inactive_users %}
            <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.last_activity }}</td>
                <td>{{ user.total_deposits|floatformat:2 }}</td>
                <td>{{ user.total_withdrawals|floatformat:2 }}</td>
                <td>{{ user.days_inactive }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if not inactive_users %}
        <p>No inactive users found in the selected range.</p>
    {% endif %}
    <form method="post" action="">
        {% csrf_token %}
        <input type="hidden" name="start_date" value="{{ start_date }}">
        <input type="hidden" name="end_date" value="{{ end_date }}">
        <input type="hidden" name="_export" value="csv">
        <button type="submit" class="btn">Download CSV</button>
    </form>
    {% if csv_data %}
        <script>
            // Trigger download of CSV data
            const csvData = "{{ csv_data|escapejs }}";
            const filename = "{{ filename|escapejs }}";
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        </script>
    {% endif %}
</div>
{% endblock %}